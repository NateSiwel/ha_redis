version: '3.8'

services:
  # ============================================================
  # Standalone Redis for Integration Testing
  # Simple single-node setup for test_integration.py
  # ============================================================

  # Redis Standalone: For integration testing (default profile)
  redis:
    image: redis:7-alpine
    container_name: redis
    command: >
      redis-server
      --appendonly yes
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 0
      --databases 16
    ports:
      - "6379:6379"
    networks:
      - ha_redis-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  # ============================================================
  # Redis HA Sentinel Topology (use with: docker compose --profile ha up)
  # Master-Replica-Sentinel configuration for high availability
  # ============================================================

  # Redis Master: Primary write node
  redis-master:
    image: redis:7-alpine
    container_name: redis-master
    profiles: ["ha"]
    command: >
      redis-server
      --appendonly yes
      --replica-announce-ip host.docker.internal
      --replica-announce-port 6380
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 0
      --databases 16
    ports:
      - "6380:6379"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - ha_redis-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  # Redis Replica: Read-only copy for failover promotion
  redis-replica:
    image: redis:7-alpine
    container_name: redis-replica
    profiles: ["ha"]
    command: >
      redis-server
      --appendonly yes
      --replicaof host.docker.internal 6380
      --replica-announce-ip host.docker.internal
      --replica-announce-port 6381
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 0
      --databases 16
    ports:
      - "6381:6379"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis-master:
        condition: service_healthy
    networks:
      - ha_redis-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  # Redis Sentinel 1: Monitoring and failover orchestration
  redis-sentinel-1:
    image: redis:7-alpine
    container_name: redis-sentinel-1
    profiles: ["ha"]
    command: sh -c "cp /etc/redis/sentinel-template.conf /tmp/sentinel.conf && redis-sentinel /tmp/sentinel.conf"
    volumes:
      - ./redis/sentinel.conf:/etc/redis/sentinel-template.conf:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis-master:
        condition: service_healthy
      redis-replica:
        condition: service_healthy
    networks:
      - ha_redis-net
    restart: unless-stopped
    ports:
      - "26379:26379"

  # Redis Sentinel 2: Monitoring and failover orchestration
  redis-sentinel-2:
    image: redis:7-alpine
    container_name: redis-sentinel-2
    profiles: ["ha"]
    command: sh -c "cp /etc/redis/sentinel-template.conf /tmp/sentinel.conf && redis-sentinel /tmp/sentinel.conf"
    volumes:
      - ./redis/sentinel.conf:/etc/redis/sentinel-template.conf:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis-master:
        condition: service_healthy
      redis-replica:
        condition: service_healthy
    networks:
      - ha_redis-net
    restart: unless-stopped
    ports:
      - "26380:26379"

  # Redis Sentinel 3: Monitoring and failover orchestration
  redis-sentinel-3:
    image: redis:7-alpine
    container_name: redis-sentinel-3
    profiles: ["ha"]
    command: sh -c "cp /etc/redis/sentinel-template.conf /tmp/sentinel.conf && redis-sentinel /tmp/sentinel.conf"
    volumes:
      - ./redis/sentinel.conf:/etc/redis/sentinel-template.conf:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis-master:
        condition: service_healthy
      redis-replica:
        condition: service_healthy
    networks:
      - ha_redis-net
    restart: unless-stopped
    ports:
      - "26381:26379"

# The 'networks' key is at the root level (no indentation)
networks:
  ha_redis-net:
    driver: bridge